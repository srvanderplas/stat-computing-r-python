name: Render and deploy Quarto files
on:
  push:
  pull_request:


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Prepare cache directories so they always exist
      - name: Prepare cache dirs
        run: |
          mkdir -p ~/.cache/pip
          mkdir -p setup/renv

      # Cache Python packages
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('setup/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Cache R packages from renv
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: renv
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      # Build Docker image
      - name: Build Docker image
        run: docker build -t local/quarto-reticulate:latest .

      # Run Docker container (optional test)
      - name: Test build inside container
        run: docker run --rm local/quarto-reticulate:latest
